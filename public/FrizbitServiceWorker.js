function uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(t){return(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)})}function updateQueryStringParameter(t,n,e){var a=new RegExp("([?&])"+n+"=.*?(&|#|$)","i");if(t.match(a))return t.replace(a,"$1"+n+"="+e+"$2");var i="";return-1!==t.indexOf("#")&&(i=t.replace(/.*#/,"#"),t=t.replace(/#.*/,"")),t+(-1!==t.indexOf("?")?"&":"?")+n+"="+e+i}var catalonia={baseUrl:"https://rb.frizbit.com/",apiVersion:1,get endpoint(){return this.baseUrl+"v"+this.apiVersion},request:{ak:"",aid:"",pl:"sw",cv:"0.0.4",es:[]},trackEvent:function(t,n){var e=raval.Adapter.DATABASES.STORAGE,a=new raval.Adapter(e),i=a.get(e.OBJECT_STORES.IDENTIFIERS),r=this;return Promise.all([i]).then(function(e){return r.request.es=[],n.en=t,"NOTIFICATIONCLICKED"===t?(n.is=!0,r.request.sid=e[0].session_id):(delete n.is,delete r.request.sid),n.sa=(new Date).getTime(),r.request.es.push(n),r.request.ak=e[0].appkey,r.request.aid=e[0].catalonia_id,fetchRequest(r.endpoint,"POST",r.request)})}},raval={};raval.Adapter=function(t){this.__parent="undefined"==typeof window?self:window,this.__database=t},raval.Adapter.DATABASES={STORAGE:{NAME:"FRIZBIT_SDK_DB",VERSION:1,OBJECT_STORES:{DATA:"data",IDENTIFIERS:"ids"}}},raval.Adapter.prototype.getInstance=function(){var t=this;return new Promise(function(n,e){var a=indexedDB.open(t.__database.NAME,t.__database.VERSION);null==a&&e(a),a.onsuccess=function(t){var e=t.target.result;e.onversionchange=function(){e.close()},n(e)},a.onerror=function(t){e(t)},a.onupgradeneeded=function(n){var e=n.target.result;for(var a in t.__database.OBJECT_STORES)e.objectStoreNames.contains(t.__database.OBJECT_STORES[a])||e.createObjectStore(t.__database.OBJECT_STORES[a])}})},raval.Adapter.prototype.get=function(t,n){var e=this;return n?new Promise(function(a,i){e.getInstance().then(function(e){e.objectStoreNames.contains(t)||i();var r=e.transaction([t],"readonly"),o=r.objectStore(t),c=o.get(n);c.onerror=function(){i(c.errorCode)},c.onsuccess=function(){a(c.result)}}).catch(function(t){i(t)})}):new Promise(function(n,a){e.getInstance().then(function(e){e.objectStoreNames.contains(t)||a();var i={},r=e.transaction([t],"readonly"),o=r.objectStore(t),c=o.openCursor();c.onerror=function(){a(c.errorCode)},c.onsuccess=function(t){var e=t.target.result;e?(i[e.key]=e.value,e.continue()):n(i)}}).catch(function(t){a(t)})})},raval.Adapter.prototype.put=function(t,n,e){var a=this;return new Promise(function(i,r){a.getInstance().then(function(a){a.objectStoreNames.contains(t)||r();var o=a.transaction([t],"readwrite"),c=o.objectStore(t),s=c.put(e,n);s.onerror=function(){r()},s.onsuccess=function(){i(n,e)}}).catch(function(t){r(t)})})};var fetchRequest=function(t,n,e){return fetch(t,{method:n,body:JSON.stringify(e),headers:{"Content-type":"text/plain;charset=UTF-8"}}).then(function(t){return t.ok||console.error("Frizbit SDK Error: "+t.status),t.json()}).then(function(t){t.error&&console.error("Frizbit SDK Error: Unable to parse response:",t.error)}).catch(function(t){console.error("Frizbit SDK Error: Unable to sent request: ",t)})};self.addEventListener("install",function(t){t.waitUntil(self.skipWaiting())}),self.addEventListener("activate",function(t){return self.clients.claim()}),self.addEventListener("push",function(t){null!=t.data&&null!=t.data.json?t.waitUntil(displayNotification(t.data.json())):console.warn("Push has no data.")}),self.addEventListener("notificationclick",function(t){if(!t||!t.notification)return void console.warn("Push has no contents.");if(t.notification.close(),t.notification.data){var n=t.notification.data,e=self.registration.scope,a="body";if(n.launchURL&&(e=n.launchURL),n.actions&&n.actions.length)for(var i=0;i<n.actions.length;i++)t.action===n.actions[i].action&&n.actions[i].url&&""!==n.actions[i].url&&(e=n.actions[i].url,a="action"+i);var r=uuidv4(),o=raval.Adapter.DATABASES.STORAGE,c=new raval.Adapter(o),s=c.put(o.OBJECT_STORES.IDENTIFIERS,"session_id",r);e=updateQueryStringParameter(e,"fjs_sid",r);var u=catalonia.trackEvent("NOTIFICATIONCLICKED",{tid:n.transactionId,ccid:n.ccid,et:a}),d=clients.matchAll({type:"window"}).then(function(){if(clients.openWindow)return clients.openWindow(e)}),l=Promise.all([s,u,d]);t.waitUntil(l)}}),self.addEventListener("notificationclose",function(t){if(!t||!t.notification||!t.notification.data)return void console.warn("Push has no contents.");var n=catalonia.trackEvent("NOTIFICATIONCLOSED",{tid:t.notification.data.transactionId,ccid:t.notification.data.ccid});t.waitUntil(n)}),self.addEventListener("pushsubscriptionchange",function(t){t.waitUntil(self.registration.pushManager.subscribe({userVisibleOnly:!0}).then(function(t){var n=JSON.parse(JSON.stringify(subscription));return catalonia.trackEvent("SUBSCRIPTIONRECEIVED",{u:{s:{ep:t.endpoint,au:n.keys.auth,k:n.keys.p256dh}}})}))});var displayNotification=function(t){if(null==t||0===Object.keys(t).length)return void console.warn("Push has no contents.");var n={title:t.t,body:t.b,icon:t.i,launchURL:t.l,sentAt:t.d,actions:t.A||[],requireInteraction:t.ri,transactionId:t.tid,ccid:t.ccid,image:t.im,tag:t.tg};return catalonia.trackEvent("NOTIFICATIONRECEIVED",{tid:n.transactionId,ccid:n.ccid}),self.registration.showNotification(n.title,{body:n.body,icon:n.icon,tag:n.tag,requireInteraction:n.requireInteraction,actions:n.actions.map(function(t){return{action:t.a,title:t.t,icon:t.i,url:t.u}}),image:n.image,data:n})};